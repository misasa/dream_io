<!DOCTYPE html>
<html>
  <head>
    <title>IMOKO-1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      .u-mb20 {
        margin-bottom: 20px;
      }
      .gbl-nav {
        background-color: #444444;
      }
      .sub-title {
        font-size: 20px;
        border-bottom: 1px solid #ccc;
      }
   </style>
  </head>
  <body>
    <nav class="gbl-nav u-mb20">
      <div class="nav-wrapper">
        <a href="#" class="brand-logo center">IMOKO-1</a>
      </div>
    </nav>
    <div class="container">
      <div class="u-mb20">
        <span class="js-state-output2"></span>
          <ul>
            <li> Click Start. </li>
            <li> Scan connection code to hear beep twice. </li>
            <li> Put a specimen. </li>
            <li> Scan specimen-ID. Confirm if quantity was updated. </li>
          </ul>
        
      </div>
      <div class="row u-mb20">
        <div class="col s4">
          <a class="waves-effect waves-light btn-large js-aircon-on">Start</a>
        </div>
        <div class="col s8">
          <span class="js-state-output"></span>
        </div>        
      </div>
      <div class="row u-mb20">
        <hr>
        <div class="col s4">
          <img src="images/B827EB682A32.png" width="100">
        </div>
        <div class="col s8">
          <ul>
           <li><h5>Address: <span class="bt-address"></span></h5></li>
           <li><h5>Data: <span class="bt-data"></span></h5></li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <div class="card">
            <div class="card-image">
            </div>
            <div class="card-content">
              <span class="card-title obj-name">----</span>
              &lt<span class="obj-id">----</span>&gt
            </div>
            <div class="card-action">
              <a class="waves-effect waves-light btn-large js-label-print">Label</a>
              <a class="waves-effect waves-light btn-large js-weigh">Weigh</a>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <div class="card blue-grey">
            <div class="card-content green-text">
              <h2 class="weight">----</h2>
            </div>
          </div>
        </div>
      </div>
      <ul id="messages" class="collection">
      </ul>
    </div>
    <script id="dataJSON" type="application/json"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.8.0.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
    <script>
       // Publisher
       pubnub = new PubNub({
         publishKey : 'pub-c-a7b58778-6fff-43b8-b87b-cf4771c8ed6c',
	       subscribeKey : 'sub-c-100d0512-eda5-11e6-889b-02ee2ddab7fe'
       })
       pubnub.addListener({
         message: function(message) {
           console.log(message);
           
           if (message.channel == 'weigh_console') {
             msg = message.message;
             console.log(msg);
             if (msg == "started"){
               state = "<h5 class='center'><i class='fa fa-play-circle-o'></i> Running</h5>";
               $('.js-state-output').html(state)
               $('.js-aircon-on').removeClass('disabled');
             }
           } else if (message.channel == 'rfcomm'){
             obj = message.message;
             console.log(obj);
             if ("address" in obj){
               $('.bt-address').html(obj.address);
             }
             if ("data" in obj){
               $('.bt-data').html(obj.data);
             } else {
                $('.bt-data').html('');
             }
             if ("medusa" in obj){
               medusa_obj = obj.medusa;
               console.log(medusa_obj);
               $('#dataJSON').html(JSON.stringify(medusa_obj));
               $('.obj-id').html(medusa_obj.global_id);        
               $('.obj-name').html(medusa_obj.datum_attributes.name);
               $('.card-image').html("<img src='https://database.misasa.okayama-u.ac.jp" + medusa_obj.datum_attributes.primary_file_thumbnail_path + "'>")
             } else {
               $('#dataJSON').html("");
               $('.obj-id').html('----');        
               $('.obj-name').html('----');
               $('.card-image').html("")
             }

           } else if (message.channel == 'weigh') {
             msg = message.message;
             if ("data" in msg){
               $('.weight').html(msg.data);
             }
             if ("log" in msg){
               $('#messages').prepend($('<li class="collection-item">').text(msg.log));
             }
           } else {
	         obj = message.message;
	         console.log("New Message!!", obj);
//             $('.weight').html(obj.weight + " " + obj.weight_unit)
//	         line = obj.id + " " + obj.name + " -> " + obj.weight + " " + obj.weight_unit + ' OK';
//	         $('#messages').prepend($('<li class="collection-item">').text(line));
           }
        
	    }
        
       });
       console.log('Subscribing...');
       pubnub.subscribe({
         channels: ['weigh','weigh_console','rfcomm','medusa']
       });
        // Publisher
      $('.js-aircon-on').click(function() {
        console.log('on');
        pubnub.publish({channel : 'weigh_console', message : 'restart'}, function(status, response){
          console.log(status, response);
          console.log(status.statusCode);
          if (status.statusCode == 200){
            console.log('success');
            state = "<div class='progress'><div class='indeterminate'></div></div>";
            $('.js-state-output').html(state);
            $('.js-aircon-on').addClass('disabled');
          }
        })

      });

      $('.js-aircon-off').click(function() {
        console.log('off');
      });

      $('.js-weigh').click(function() {
        console.log('weigh...');
        $('.weight').html('----');
        var json = $('#dataJSON').html();
        var obj = $.parseJSON(json);
        var gid = $('.obj-id').text();
        var name = $('.obj-name').text();
        console.log(obj);
        console.log('ID: ' + gid);
        console.log('NAME: ' + name);
        //$.post('http://172.24.1.121:8889/print', {'data': gid + ',' + name})
        pubnub.publish({channel : 'weigh', message : {command:'get_and_save', object: obj}}, function(status, response){
          console.log(status, response);
          console.log(status.statusCode);
          if (status.statusCode == 200){
            console.log('success');
          }});


        });

      $('.js-label-print').click(function() {
        console.log('label printing...');
        var gid = $('.obj-id').text();
        var name = $('.obj-name').text();
        console.log('ID: ' + gid);
        console.log('NAME: ' + name);
        $.post('http://172.24.1.121:8889/print', {'data': gid + ',' + name})
      });

      $('.js-load').click(function() {
        console.log('loading...');
        $('.obj-id').html('&lt' + '201705101225-0000' + '&gt')        
        $('.obj-name').html('deleteme.stone')
        $('.weight').html('123.45 g') 
      });

       $('form').submit(function(){
         $.post('/reset');
	       $('#status').text('restarting dream-io. please reload this page after while.');
       });
    </script>
  </body>
</html>
